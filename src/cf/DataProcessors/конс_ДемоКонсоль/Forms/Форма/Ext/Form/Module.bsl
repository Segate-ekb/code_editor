////////////////////////////////////////////////////////////////////////////////
// Форма консоли кода
// 
// Пример подключения редактора bsl_console к форме.
// Минимальный код подключения - см. ПриСозданииНаСервере и ПриОткрытии.
//
// Примеры расширения функциональности - см. область "Примеры".
////////////////////////////////////////////////////////////////////////////////

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// === ПОДКЛЮЧЕНИЕ РЕДАКТОРА (обязательно) ===
	// Пример с нестандартным именем элемента:
	конс_ПодключаемаяКонсольСервер.ИнициализироватьРедактор(ЭтотОбъект, УникальныйИдентификатор, "ПолеРедактора");
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	// === ПОДКЛЮЧЕНИЕ РЕДАКТОРА (обязательно) ===
	конс_ПодключаемаяКонсольКлиент.ПодключитьРедактор(ЭтаФорма);
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовФормы

&НаКлиенте
Процедура ПолеРедактораПриНажатии(Элемент, ДанныеСобытия, СтандартнаяОбработка)
	
	// === ОБРАБОТКА СОБЫТИЙ РЕДАКТОРА (обязательно) ===
	конс_ПодключаемаяКонсольКлиент.ОбработчикПриНажатии(ЭтаФорма, ДанныеСобытия);
	
КонецПроцедуры

&НаКлиенте
Процедура ПолеРедактораДокументСформирован(Элемент)
	
	// === ЗАВЕРШЕНИЕ ИНИЦИАЛИЗАЦИИ (обязательно) ===
	конс_ПодключаемаяКонсольКлиент.ОбработчикДокументСформирован(ЭтаФорма);

	// === ПРИМЕРЫ РАСШИРЕНИЯ (опционально) ===
	// Добавление пользовательского контекста выполняется на сервере,
	// а загрузка в редактор - после формирования документа (см. HTMLДокументСформирован)
	Пример_ДобавитьПеременные();
	Пример_ДобавитьФункции();
	Пример_ДобавитьСниппеты();

	// === ЗАГРУЗКА ПОЛЬЗОВАТЕЛЬСКОГО КОНТЕКСТА (опционально) ===
	// Загружает в редактор переменные, функции и сниппеты,
	// добавленные на сервере в ПриСозданииНаСервере
	конс_ПодключаемаяКонсольКлиент.ЗагрузитьПользовательскийКонтекст(ЭтаФорма);
	
	// === ПРИМЕР ЗАГРУЗКИ СХЕМЫ (опционально) ===
	// Загружает демонстрационную JSON-схему для переменных
	// СоответствиеСоСхемой и СтруктураСоСхемой
	Пример_ЗагрузитьСхему();
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ОткрытьНастройки(Команда)
	
	конс_ПодключаемаяКонсольКлиент.ОткрытьНастройкиРедактора();
	
КонецПроцедуры

&НаКлиенте
Процедура ПереключитьНаBSL(Команда)
	
	конс_ПодключаемаяКонсольКлиент.УстановитьРежимЯзыка(ЭтаФорма, "bsl");
	
КонецПроцедуры

&НаКлиенте
Процедура ПереключитьНаJSON(Команда)
	
	конс_ПодключаемаяКонсольКлиент.УстановитьРежимЯзыка(ЭтаФорма, "json");
	
КонецПроцедуры

&НаКлиенте
Процедура ПереключитьНаYAML(Команда)
	
	конс_ПодключаемаяКонсольКлиент.УстановитьРежимЯзыка(ЭтаФорма, "yaml");
	
КонецПроцедуры

// === ТЕСТОВЫЕ ДАННЫЕ ===

&НаСервере
Функция ПолучитьТекстМакета(ИмяМакета)
	
	Возврат Обработки.конс_ДемоКонсоль.ПолучитьМакет(ИмяМакета).ПолучитьТекст();
	
КонецФункции

&НаКлиенте
Процедура ТестBSL(Команда)
	
	Текст = ПолучитьТекстМакета("ТестBSL");
	
	конс_ПодключаемаяКонсольКлиент.ОчиститьТекст(ЭтаФорма);
	конс_ПодключаемаяКонсольКлиент.УстановитьРежимЯзыка(ЭтаФорма, "bsl");
	конс_ПодключаемаяКонсольКлиент.УстановитьТекст(ЭтаФорма, Текст);
	
КонецПроцедуры

&НаКлиенте
Процедура ТестBSLОтладчик(Команда)
	
	Текст = ПолучитьТекстМакета("ТестBSLОтладчик");
	
	конс_ПодключаемаяКонсольКлиент.ОчиститьТекст(ЭтаФорма);
	конс_ПодключаемаяКонсольКлиент.УстановитьРежимЯзыка(ЭтаФорма, "bsl");
	конс_ПодключаемаяКонсольКлиент.УстановитьТекст(ЭтаФорма, Текст);
	
КонецПроцедуры

&НаКлиенте
Процедура ТестСхемы(Команда)
	
	Текст = ПолучитьТекстМакета("ТестСхемы");
	
	конс_ПодключаемаяКонсольКлиент.ОчиститьТекст(ЭтаФорма);
	конс_ПодключаемаяКонсольКлиент.УстановитьРежимЯзыка(ЭтаФорма, "bsl");
	конс_ПодключаемаяКонсольКлиент.УстановитьТекст(ЭтаФорма, Текст);
	
	// Автоматически загружаем Petstore OpenAPI схему для работы автодополнения
	Пример_ЗагрузитьСхему();
	
КонецПроцедуры

&НаКлиенте
Процедура ТестJSON(Команда)
	
	Текст = ПолучитьТекстМакета("ТестJSON");
	
	конс_ПодключаемаяКонсольКлиент.ОчиститьТекст(ЭтаФорма);
	конс_ПодключаемаяКонсольКлиент.УстановитьРежимЯзыка(ЭтаФорма, "json");
	конс_ПодключаемаяКонсольКлиент.УстановитьТекст(ЭтаФорма, Текст);
	
КонецПроцедуры

&НаКлиенте
Процедура ТестYAML(Команда)
	
	Текст = ПолучитьТекстМакета("ТестYAML");
	
	конс_ПодключаемаяКонсольКлиент.ОчиститьТекст(ЭтаФорма);
	конс_ПодключаемаяКонсольКлиент.УстановитьРежимЯзыка(ЭтаФорма, "yaml");
	конс_ПодключаемаяКонсольКлиент.УстановитьТекст(ЭтаФорма, Текст);
	
КонецПроцедуры

&НаКлиенте
Процедура ТестЗапрос(Команда)
	
	Текст = ПолучитьТекстМакета("ТестЗапрос");
	
	конс_ПодключаемаяКонсольКлиент.ОчиститьТекст(ЭтаФорма);
	конс_ПодключаемаяКонсольКлиент.УстановитьРежимЯзыка(ЭтаФорма, "bsl_query");
	конс_ПодключаемаяКонсольКлиент.УстановитьТекст(ЭтаФорма, Текст);
	
КонецПроцедуры

&НаКлиенте
Процедура ТестXML(Команда)
	
	Текст = ПолучитьТекстМакета("ТестXML");
	
	конс_ПодключаемаяКонсольКлиент.ОчиститьТекст(ЭтаФорма);
	конс_ПодключаемаяКонсольКлиент.УстановитьРежимЯзыка(ЭтаФорма, "xml");
	конс_ПодключаемаяКонсольКлиент.УстановитьТекст(ЭтаФорма, Текст);
	
КонецПроцедуры

&НаКлиенте
Процедура ТестСКД(Команда)
	
	Текст = ПолучитьТекстМакета("ТестСКД");
	
	конс_ПодключаемаяКонсольКлиент.ОчиститьТекст(ЭтаФорма);
	конс_ПодключаемаяКонсольКлиент.УстановитьРежимЯзыка(ЭтаФорма, "dcs_query");
	конс_ПодключаемаяКонсольКлиент.УстановитьТекст(ЭтаФорма, Текст);
	
КонецПроцедуры

// === ЗАМЕР ПРОИЗВОДИТЕЛЬНОСТИ ===

&НаКлиенте
Процедура ЗамерПроизводительности(Команда)
	
	Текст = конс_ПодключаемаяКонсольКлиент.ПолучитьТекст(ЭтаФорма);
	
	Если НЕ ЗначениеЗаполнено(Текст) Тогда
		ПоказатьПредупреждение(, "Редактор пуст. Введите код для замера производительности.");
		Возврат;
	КонецЕсли;
	
	НачалоЗамера = ТекущаяУниверсальнаяДатаВМиллисекундах();
	
	// Выполняем код на сервере через существующий механизм консоли
	РежимПеременных = ПредопределенноеЗначение("Перечисление.конс_РежимПоказаПеременных.НеОтображать");
	Результат = конс_ПодключаемаяКонсольВызовСервера.ВыполнитьКодНаСервере(Текст, РежимПеременных);
	
	КонецЗамера = ТекущаяУниверсальнаяДатаВМиллисекундах();
	ВремяВыполнения = КонецЗамера - НачалоЗамера;
	
	Если НЕ Результат.Успешно Тогда
		ОписаниеОшибки = "";
		Если Результат.ИнформацияОбОшибке <> Неопределено Тогда
			ОписаниеОшибки = Результат.ИнформацияОбОшибке.Описание;
		ИначеЕсли ЗначениеЗаполнено(Результат.ОписаниеОшибки) Тогда
			ОписаниеОшибки = Результат.ОписаниеОшибки;
		Иначе
			ОписаниеОшибки = "Неизвестная ошибка";
		КонецЕсли;
		ПоказатьПредупреждение(, "Ошибка выполнения кода:" + Символы.ПС + ОписаниеОшибки);
		Возврат;
	КонецЕсли;
	
	СтрокаВремени = ФорматироватьВремяВыполнения(ВремяВыполнения);
	ПоказатьОповещениеПользователя("Замер производительности", , "Время выполнения: " + СтрокаВремени);
	
КонецПроцедуры

&НаКлиенте
Функция ФорматироватьВремяВыполнения(ВремяВыполнения)
	
	Если ВремяВыполнения < 1000 Тогда
		Возврат Формат(ВремяВыполнения, "ЧГ=0") + " мс";
	ИначеЕсли ВремяВыполнения < 60000 Тогда
		Возврат Формат(ВремяВыполнения / 1000, "ЧДЦ=3; ЧГ=0") + " сек";
	Иначе
		Минуты = Цел(ВремяВыполнения / 60000);
		Секунды = (ВремяВыполнения - Минуты * 60000) / 1000;
		Возврат Формат(Минуты, "ЧГ=0") + " мин " + Формат(Секунды, "ЧДЦ=1; ЧГ=0") + " сек";
	КонецЕсли;
	
КонецФункции

#КонецОбласти

#Область Примеры

////////////////////////////////////////////////////////////////////////////////
// ПРИМЕРЫ РАСШИРЕНИЯ ФУНКЦИОНАЛЬНОСТИ
// 
// Методы ниже демонстрируют возможности расширения редактора.
// Вызываются в ПриСозданииНаСервере - добавляют контекст.
// Загрузка контекста в редактор - в HTMLДокументСформирован.
////////////////////////////////////////////////////////////////////////////////

// Пример: Добавление пользовательских переменных
// 
// Переменные отображаются в автодополнении при вводе.
// При вводе точки после переменной появятся методы её типа.
//
&НаСервере
Процедура Пример_ДобавитьПеременные()
	
	// Вариант 1: По ОписаниюТипов (для объектов конфигурации)
	// При вводе "_Товар." появятся все реквизиты справочника
	Если Метаданные.Справочники.Найти("Номенклатура") <> Неопределено Тогда
		конс_ПодключаемаяКонсольСервер.ДобавитьПеременную(ЭтотОбъект, "_Товар",
			Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));
	КонецЕсли;
	
	// Вариант 2: По типу через Тип() - для общих классов платформы
	// При вводе "_Данные." появятся методы: Вставить(), Свойство(), Количество() и т.д.
	конс_ПодключаемаяКонсольСервер.ДобавитьПеременную(ЭтотОбъект, "_Данные",
		Тип("Структура"));
	
	// При вводе "_Таблица." появятся методы: Добавить(), Найти(), Скопировать() и т.д.
	конс_ПодключаемаяКонсольСервер.ДобавитьПеременную(ЭтотОбъект, "_Таблица",
		Тип("ТаблицаЗначений"));
	
	// Вариант 3: По строке с именем типа
	Если Метаданные.Справочники.Найти("Контрагенты") <> Неопределено Тогда
		конс_ПодключаемаяКонсольСервер.ДобавитьПеременную(ЭтотОбъект, "_Клиент",
			"Справочник.Контрагенты");
	КонецЕсли;
	
	// Вариант 4: Простая переменная с указанием типа
	конс_ПодключаемаяКонсольСервер.ДобавитьПеременную(ЭтотОбъект, "_Результат", Тип("Массив"));
	
	// Переменные со схемой регистрируются динамически в Пример_ЗагрузитьСхему()
	// через ЗагрузитьФайлСхемы — они сами добавятся в автодополнение.
	
КонецПроцедуры

// Пример: Добавление пользовательских функций
// 
// Функции отображаются в автодополнении с описанием и сигнатурой.
// Реализация функций должна быть в модуле менеджера (см. ManagerModule.bsl).
//
&НаСервере
Процедура Пример_ДобавитьФункции()
	
	// Функция с параметрами
	ПараметрыФункции = Новый Массив;
	ПараметрыФункции.Добавить(конс_ПодключаемаяКонсольСервер.НовыйПараметрФункции(
		"Сумма", "Число", "Сумма заказа для расчёта"));
	ПараметрыФункции.Добавить(конс_ПодключаемаяКонсольСервер.НовыйПараметрФункции(
		"ПроцентСкидки", "Число", "Процент скидки (от 0 до 100)"));
	
	конс_ПодключаемаяКонсольСервер.ДобавитьФункциюВКонтекст(ЭтотОбъект,
		"ВычислитьСкидку",
		"Вычисляет скидку для клиента",
		ПараметрыФункции,
		"Число"); // тип возврата
	
	// Функция без параметров
	конс_ПодключаемаяКонсольСервер.ДобавитьФункциюВКонтекст(ЭтотОбъект,
		"ПолучитьТекущегоПользователя",
		"Возвращает текущего пользователя системы");
	
КонецПроцедуры

// Пример: Добавление сниппетов (шаблонов кода)
// 
// Сниппеты - быстрые шаблоны, разворачиваются по Tab.
// ${1}, ${2} - точки табуляции, ${0} - финальная позиция курсора.
//
&НаСервере
Процедура Пример_ДобавитьСниппеты()
	
	// Сниппет для цикла
	конс_ПодключаемаяКонсольСервер.ДобавитьСниппет(ЭтотОбъект,
		"Для",
		"Для ${1:Индекс} = ${2:0} По ${3:Количество} - 1 Цикл
		|	${0}
		|КонецЦикла;",
		"Цикл Для по числовому счётчику");
	
	// Сниппет для запроса (префикс "НовыйЗапрос", а не "Запрос",
	// т.к. "Запрос" — имя класса в bslGlobals, и автодополнение класса
	// перехватит ввод раньше, чем сниппет)
	конс_ПодключаемаяКонсольСервер.ДобавитьСниппет(ЭтотОбъект,
		"НовыйЗапрос",
		"ЗапросИзСниппета = Новый Запрос;
		|ЗапросИзСниппета.Текст =
		|	""ВЫБРАТЬ
		|	|	${1:*}
		|	|ИЗ
		|	|	${2:Справочник.Номенклатура}"";
		|
		|Результат = ЗапросИзСниппета.Выполнить();
		|Выборка = Результат.Выбрать();
		|
		|Пока Выборка.Следующий() Цикл
		|	${0}
		|КонецЦикла;",
		"Создание и выполнение запроса");
	
КонецПроцедуры

// Пример: Привязка OpenAPI-схемы к переменным
//
// Загружает компактную версию Petstore OpenAPI и регистрирует
// переменные Pet, Category, Tag, Order с автодополнением свойств.
// Демонстрирует работу $ref (ссылочных типов) и enum.
//
// Для загрузки собственной схемы используйте меню Схема → Загрузить схему...
//
&НаКлиенте
Процедура Пример_ЗагрузитьСхему()
	
	// Демо: Petstore OpenAPI (компактная версия со ссылочными типами)
	JSONСхемы =
		"{
		|  ""openapi"": ""3.0.0"",
		|  ""components"": {
		|    ""schemas"": {
		|      ""Pet"": {
		|        ""type"": ""object"",
		|        ""properties"": {
		|          ""id"":       { ""type"": ""integer"", ""description"": ""Unique ID"" },
		|          ""name"":     { ""type"": ""string"",  ""description"": ""Pet name"" },
		|          ""category"": { ""$ref"": ""#/components/schemas/Category"" },
		|          ""photoUrls"": { ""type"": ""array"", ""items"": { ""type"": ""string"" } },
		|          ""tags"":     { ""type"": ""array"",   ""items"": { ""$ref"": ""#/components/schemas/Tag"" } },
		|          ""status"":   { ""type"": ""string"",  ""enum"": [""available"", ""pending"", ""sold""] }
		|        }
		|      },
		|      ""Category"": {
		|        ""type"": ""object"",
		|        ""properties"": {
		|          ""id"":   { ""type"": ""integer"" },
		|          ""name"": { ""type"": ""string"", ""description"": ""Category name"" }
		|        }
		|      },
		|      ""Tag"": {
		|        ""type"": ""object"",
		|        ""properties"": {
		|          ""id"":   { ""type"": ""integer"" },
		|          ""name"": { ""type"": ""string"", ""description"": ""Tag name"" }
		|        }
		|      },
		|      ""Order"": {
		|        ""type"": ""object"",
		|        ""properties"": {
		|          ""id"":       { ""type"": ""integer"" },
		|          ""petId"":    { ""type"": ""integer"", ""description"": ""Pet ID"" },
		|          ""quantity"": { ""type"": ""integer"" },
		|          ""shipDate"": { ""type"": ""string"",  ""format"": ""date-time"" },
		|          ""status"":   { ""type"": ""string"",  ""enum"": [""placed"", ""approved"", ""delivered""] },
		|          ""complete"": { ""type"": ""boolean"" }
		|        }
		|      },
		|      ""User"": {
		|        ""type"": ""object"",
		|        ""properties"": {
		|          ""id"":         { ""type"": ""integer"" },
		|          ""username"":   { ""type"": ""string"",  ""description"": ""Login name"" },
		|          ""firstName"":  { ""type"": ""string"" },
		|          ""lastName"":   { ""type"": ""string"" },
		|          ""email"":      { ""type"": ""string"",  ""format"": ""email"" },
		|          ""password"":   { ""type"": ""string"" },
		|          ""phone"":      { ""type"": ""string"" },
		|          ""userStatus"": { ""type"": ""integer"", ""description"": ""User status"" }
		|        }
		|      },
		|      ""ApiResponse"": {
		|        ""type"": ""object"",
		|        ""properties"": {
		|          ""code"":    { ""type"": ""integer"" },
		|          ""type"":    { ""type"": ""string"" },
		|          ""message"": { ""type"": ""string"",  ""description"": ""Response message"" }
		|        }
		|      }
		|    }
		|  }
		|}";
	
	// Загружаем все типы из схемы — каждый станет переменной с автодополнением
	// Например: Pet[" → id, name, category...
	//           Order. → id, petId, quantity...
	конс_ПодключаемаяКонсольКлиент.ЗагрузитьФайлСхемы(ЭтаФорма, JSONСхемы);
	
	// === ИМИТАЦИЯ СПРАВОЧНИКА ===
	// В реальном сценарии JSONСхемы и ИмяТипа хранятся в реквизитах справочника.
	// При открытии консоли из справочника привязываем переменную "Результат"
	// к конкретному типу из схемы — пользователь работает через Результат.
	конс_ПодключаемаяКонсольКлиент.ЗагрузитьСхемуПеременной(ЭтаФорма, "Результат", JSONСхемы, "Pet");
	
КонецПроцедуры

#КонецОбласти

#Область ТестированиеAPI

////////////////////////////////////////////////////////////////////////////////
// ТЕСТИРОВАНИЕ API РЕДАКТОРА
// 
// Команды для проверки работы различных параметров редактора.
////////////////////////////////////////////////////////////////////////////////

// Переключает режим "только чтение" редактора.
//
&НаКлиенте
Процедура ПереключитьТолькоЧтение(Команда)
	
	элементы.ПереключитьТолькоЧтение.Пометка = НЕ элементы.ПереключитьТолькоЧтение.Пометка;
	конс_ПодключаемаяКонсольКлиент.УстановитьРежимТолькоЧтение(ЭтаФорма, элементы.ПереключитьТолькоЧтение.Пометка);
	
	Если элементы.ПереключитьТолькоЧтение.Пометка Тогда
		ПоказатьОповещениеПользователя("Режим только чтение", , "Редактирование запрещено");
	Иначе
		ПоказатьОповещениеПользователя("Режим редактирования", , "Редактирование разрешено");
	КонецЕсли;
	
КонецПроцедуры

// Получает и показывает текущий текст редактора.
//
&НаКлиенте
Процедура ПолучитьТекст(Команда)
	
	Текст = конс_ПодключаемаяКонсольКлиент.ПолучитьТекст(ЭтаФорма);
	
	Если ЗначениеЗаполнено(Текст) Тогда
		СтрокСообщение = СтрШаблон("Получено символов: %1, строк: %2", СтрДлина(Текст), СтрЧислоСтрок(Текст));
		ПоказатьОповещениеПользователя("Получение текста", , СтрокСообщение);
	Иначе
		ПоказатьОповещениеПользователя("Получение текста", , "Редактор пуст");
	КонецЕсли;
	
КонецПроцедуры

// Получает и показывает выделенный текст.
//
&НаКлиенте
Процедура ПолучитьВыделенныйТекст(Команда)
	
	Текст = конс_ПодключаемаяКонсольКлиент.ПолучитьВыделенныйТекст(ЭтаФорма);
	
	Если ЗначениеЗаполнено(Текст) Тогда
		ПоказатьПредупреждение(, "Выделенный текст:" + Символы.ПС + Символы.ПС + Текст);
	Иначе
		ПоказатьОповещениеПользователя("Выделение", , "Текст не выделен");
	КонецЕсли;
	
КонецПроцедуры

// Очищает редактор.
//
&НаКлиенте
Процедура ОчиститьРедактор(Команда)
	
	конс_ПодключаемаяКонсольКлиент.ОчиститьТекст(ЭтаФорма);
	ПоказатьОповещениеПользователя("Очистка", , "Редактор очищен");
	
КонецПроцедуры

// Переключает на режим SQL-запроса.
//
&НаКлиенте
Процедура ПереключитьНаЗапрос(Команда)
	
	конс_ПодключаемаяКонсольКлиент.УстановитьРежимЯзыка(ЭтаФорма, "bsl_query");
	ПоказатьОповещениеПользователя("Язык", , "Режим запроса 1С");
	
КонецПроцедуры

// Переключает на режим XML.
//
&НаКлиенте
Процедура ПереключитьНаXML(Команда)
	
	конс_ПодключаемаяКонсольКлиент.УстановитьРежимЯзыка(ЭтаФорма, "xml");
	ПоказатьОповещениеПользователя("Язык", , "Режим XML");
	
КонецПроцедуры

// Переключает на режим СКД-запроса.
//
&НаКлиенте
Процедура ПереключитьНаСКД(Команда)
	
	конс_ПодключаемаяКонсольКлиент.УстановитьРежимЯзыка(ЭтаФорма, "dcs_query");
	ПоказатьОповещениеПользователя("Язык", , "Режим запроса СКД");
	
КонецПроцедуры

#КонецОбласти

#Область СхемыПеременных

////////////////////////////////////////////////////////////////////////////////
// ПРИВЯЗКА JSON-СХЕМ К ПЕРЕМЕННЫМ
// 
// Загрузка OpenAPI / Swagger / JSON Schema из файла.
// Каждый тип из схемы становится переменной с автодополнением свойств.
////////////////////////////////////////////////////////////////////////////////

// Загружает JSON-схему из файла и регистрирует типы как переменные.
//
&НаКлиенте
Процедура ЗагрузитьСхему(Команда)
	
	ОписаниеОповещения = Новый ОписаниеОповещения("ЗагрузитьСхемуЗавершение", ЭтотОбъект);
	НачатьПомещениеФайла(ОписаниеОповещения, , , Истина, УникальныйИдентификатор);
	
КонецПроцедуры

&НаКлиенте
Процедура ЗагрузитьСхемуЗавершение(Результат, Адрес, ВыбранноеИмяФайла, ДополнительныеПараметры) Экспорт
	
	Если НЕ Результат Тогда
		Возврат; // Пользователь отменил выбор
	КонецЕсли;
	
	JSONСхемы = ПрочитатьСхемуИзХранилища(Адрес, ВыбранноеИмяФайла);
	
	Если НЕ ЗначениеЗаполнено(JSONСхемы) Тогда
		ПоказатьПредупреждение(, "Не удалось прочитать файл схемы.");
		Возврат;
	КонецЕсли;
	
	// Загружаем все типы из схемы и регистрируем как переменные
	СтрокаТипов = конс_ПодключаемаяКонсольКлиент.ЗагрузитьФайлСхемы(ЭтаФорма, JSONСхемы);
	
	Если НЕ ЗначениеЗаполнено(СтрокаТипов) Тогда
		ПоказатьПредупреждение(, "Не удалось распознать типы в файле схемы.");
		Возврат;
	КонецЕсли;
	
	ИмяФайла = ВыбранноеИмяФайла;
	Позиция = СтрНайти(ИмяФайла, "\", НаправлениеПоиска.СКонца);
	Если Позиция > 0 Тогда
		ИмяФайла = Сред(ИмяФайла, Позиция + 1);
	КонецЕсли;
	
	ПоказатьОповещениеПользователя("Схема загружена",
		, "Файл: " + ИмяФайла + Символы.ПС
		+ "Переменные: " + СтрокаТипов);
	
КонецПроцедуры

&НаСервере
Функция ПрочитатьСхемуИзХранилища(Знач Адрес, Знач ИмяФайла)
	
	Попытка
		ДвоичныеДанные = ПолучитьИзВременногоХранилища(Адрес);
	Исключение
		Возврат "";
	КонецПопытки;
	
	Если ДвоичныеДанные = Неопределено Тогда
		Возврат "";
	КонецЕсли;
	
	ИмяВременногоФайла = ПолучитьИмяВременногоФайла();
	ДвоичныеДанные.Записать(ИмяВременногоФайла);
	
	ТекстовыйДокумент = Новый ТекстовыйДокумент;
	ТекстовыйДокумент.Прочитать(ИмяВременногоФайла, КодировкаТекста.UTF8);
	Содержимое = ТекстовыйДокумент.ПолучитьТекст();
	
	Попытка
		УдалитьФайлы(ИмяВременногоФайла);
	Исключение
		ИмяВременногоФайла = ""; // Не критично
	КонецПопытки;
	
	Возврат Содержимое;
	
КонецФункции

// Очищает привязанные схемы переменных.
//
&НаКлиенте
Процедура ОчиститьСхемы(Команда)
	
	конс_ПодключаемаяКонсольКлиент.ОчиститьСхемыПеременных(ЭтаФорма);
	ПоказатьОповещениеПользователя("Схемы очищены", , "Привязки схем к переменным удалены");
	
КонецПроцедуры

#КонецОбласти
