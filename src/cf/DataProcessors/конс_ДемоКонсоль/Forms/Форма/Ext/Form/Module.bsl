////////////////////////////////////////////////////////////////////////////////
// Форма консоли кода
// 
// Пример подключения редактора bsl_console к форме.
// Минимальный код подключения - см. ПриСозданииНаСервере и ПриОткрытии.
//
// Примеры расширения функциональности - см. область "Примеры".
////////////////////////////////////////////////////////////////////////////////

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// === ПОДКЛЮЧЕНИЕ РЕДАКТОРА (обязательно) ===
	конс_ПодключаемаяКонсольСервер.ИнициализироватьРедактор(ЭтотОбъект, УникальныйИдентификатор);
		
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	// === ПОДКЛЮЧЕНИЕ РЕДАКТОРА (обязательно) ===
	конс_ПодключаемаяКонсольКлиент.ПодключитьРедактор(ЭтаФорма);
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовФормы

&НаКлиенте
Процедура HTMLПриНажатии(Элемент, ДанныеСобытия, СтандартнаяОбработка)
	
	// === ОБРАБОТКА СОБЫТИЙ РЕДАКТОРА (обязательно) ===
	конс_ПодключаемаяКонсольКлиент.ОбработчикПриНажатии(ЭтаФорма, ДанныеСобытия);
	
КонецПроцедуры

&НаКлиенте
Процедура HTMLДокументСформирован(Элемент)
	
	// === ЗАВЕРШЕНИЕ ИНИЦИАЛИЗАЦИИ (обязательно) ===
	конс_ПодключаемаяКонсольКлиент.ОбработчикДокументСформирован(ЭтаФорма);

	// === ПРИМЕРЫ РАСШИРЕНИЯ (опционально) ===
	// Добавление пользовательского контекста выполняется на сервере,
	// а загрузка в редактор - после формирования документа (см. HTMLДокументСформирован)
	Пример_ДобавитьПеременные();
	Пример_ДобавитьФункции();
	Пример_ДобавитьСниппеты();

	// === ЗАГРУЗКА ПОЛЬЗОВАТЕЛЬСКОГО КОНТЕКСТА (опционально) ===
	// Загружает в редактор переменные, функции и сниппеты,
	// добавленные на сервере в ПриСозданииНаСервере
	конс_ПодключаемаяКонсольКлиент.ЗагрузитьПользовательскийКонтекст(ЭтаФорма);
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ВыполнитьКод(Команда)
	
	// === ВЫПОЛНЕНИЕ КОДА (3 строки) ===
	Код = конс_ПодключаемаяКонсольКлиент.ПодготовитьКодСПеременными(ЭтаФорма);
	
	Если Не ЗначениеЗаполнено(Код) Тогда
		ПоказатьПредупреждение(, "Нет кода для выполнения!");
		Возврат;
	КонецЕсли;
	
	Результат = конс_ПодключаемаяКонсольВызовСервера.ВыполнитьКодНаСервере(Код, ПредопределенноеЗначение("Перечисление.конс_РежимПоказаПеременных.ВТабло"));
	конс_ПодключаемаяКонсольКлиент.ОбработатьРезультат(ЭтаФорма, Результат);
	
КонецПроцедуры

&НаКлиенте
Процедура ОткрытьНастройки(Команда)
	
	конс_ПодключаемаяКонсольКлиент.ОткрытьНастройкиРедактора();
	
КонецПроцедуры

&НаКлиенте
Процедура ПереключитьНаBSL(Команда)
	
	конс_ПодключаемаяКонсольКлиент.УстановитьРежимЯзыка(ЭтаФорма, "bsl");
	
КонецПроцедуры

&НаКлиенте
Процедура ПереключитьНаJSON(Команда)
	
	конс_ПодключаемаяКонсольКлиент.УстановитьРежимЯзыка(ЭтаФорма, "json");
	
КонецПроцедуры

&НаКлиенте
Процедура ПереключитьНаYAML(Команда)
	
	конс_ПодключаемаяКонсольКлиент.УстановитьРежимЯзыка(ЭтаФорма, "yaml");
	
КонецПроцедуры

&НаКлиенте
Процедура ВнешнееВыполнениеКода(Команда)
	
	// === ПРИМЕР ВНЕШНЕГО ВЫПОЛНЕНИЯ КОДА ===
	// Используется, когда нужно выполнить код в своём контексте,
	// а не через стандартный ВыполнитьКод.
	// 
	// Например:
	// - Выполнение на клиенте с доступом к элементам формы
	// - Выполнение в контексте модуля объекта
	// - Выполнение с предварительной подготовкой данных
	
	// 1. Получаем подготовленный код
	ДанныеКода = конс_ПодключаемаяКонсольКлиент.ПолучитьКодДляВнешнегоВыполнения(ЭтаФорма);
	
	Если Не ЗначениеЗаполнено(ДанныеКода.ИсходныйКод) Тогда
		ПоказатьПредупреждение(, "Нет кода для выполнения!");
		Возврат;
	КонецЕсли;
	
	// 2. Выполняем код в своём контексте
	ИнфоОшибки = Неопределено;
	
	Попытка
		// Здесь можно использовать свой Выполнить
		// Код уже содержит всё необходимое:
		// - Объявление ЗначенияПеременных
		// - Сбор значений переменных
		// - Сохранение во временное хранилище
		ВыполнитьКодНаСервере(ДанныеКода.Код);
	Исключение
		ИнфоОшибки = ИнформацияОбОшибке();
	КонецПопытки;
	
	// 3. Обрабатываем результат - покажет переменные или ошибку
	конс_ПодключаемаяКонсольКлиент.ОбработатьРезультатВнешнегоВыполнения(
		ЭтаФорма, ДанныеКода, ИнфоОшибки);
	
КонецПроцедуры

&НаСервере
Процедура ВыполнитьКодНаСервере(Код)

Выполнить(Код);

КонецПроцедуры

#КонецОбласти

#Область Примеры

////////////////////////////////////////////////////////////////////////////////
// ПРИМЕРЫ РАСШИРЕНИЯ ФУНКЦИОНАЛЬНОСТИ
// 
// Методы ниже демонстрируют возможности расширения редактора.
// Вызываются в ПриСозданииНаСервере - добавляют контекст.
// Загрузка контекста в редактор - в HTMLДокументСформирован.
////////////////////////////////////////////////////////////////////////////////

// Пример: Добавление пользовательских переменных
// 
// Переменные отображаются в автодополнении при вводе.
// При вводе точки после переменной появятся методы её типа.
//
&НаСервере
Процедура Пример_ДобавитьПеременные()
	
	// Вариант 1: По ОписаниюТипов (для объектов конфигурации)
	// При вводе "_Товар." появятся все реквизиты справочника
	Если Метаданные.Справочники.Найти("Номенклатура") <> Неопределено Тогда
		конс_ПодключаемаяКонсольСервер.ДобавитьПеременную(ЭтотОбъект, "_Товар",
			Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));
	КонецЕсли;
	
	// Вариант 2: По типу через Тип() - для общих классов платформы
	// При вводе "_Данные." появятся методы: Вставить(), Свойство(), Количество() и т.д.
	конс_ПодключаемаяКонсольСервер.ДобавитьПеременную(ЭтотОбъект, "_Данные",
		Тип("Структура"));
	
	// При вводе "_Таблица." появятся методы: Добавить(), Найти(), Скопировать() и т.д.
	конс_ПодключаемаяКонсольСервер.ДобавитьПеременную(ЭтотОбъект, "_Таблица",
		Тип("ТаблицаЗначений"));
	
	// Вариант 3: По строке с именем типа
	Если Метаданные.Справочники.Найти("Контрагенты") <> Неопределено Тогда
		конс_ПодключаемаяКонсольСервер.ДобавитьПеременную(ЭтотОбъект, "_Клиент",
			"Справочник.Контрагенты");
	КонецЕсли;
	
	// Вариант 4: Простая переменная с указанием типа
	конс_ПодключаемаяКонсольСервер.ДобавитьПеременную(ЭтотОбъект, "_Результат", Тип("Массив"));
	
КонецПроцедуры

// Пример: Добавление пользовательских функций
// 
// Функции отображаются в автодополнении с описанием и сигнатурой.
// Реализация функций должна быть в модуле менеджера (см. ManagerModule.bsl).
//
&НаСервере
Процедура Пример_ДобавитьФункции()
	
	// Функция с параметрами
	ПараметрыФункции = Новый Массив;
	ПараметрыФункции.Добавить(конс_ПодключаемаяКонсольСервер.НовыйПараметрФункции(
		"Сумма", "Число", "Сумма заказа для расчёта"));
	ПараметрыФункции.Добавить(конс_ПодключаемаяКонсольСервер.НовыйПараметрФункции(
		"ПроцентСкидки", "Число", "Процент скидки (от 0 до 100)"));
	
	конс_ПодключаемаяКонсольСервер.ДобавитьФункциюВКонтекст(ЭтотОбъект,
		"ВычислитьСкидку",
		"Вычисляет скидку для клиента",
		ПараметрыФункции,
		"Число"); // тип возврата
	
	// Функция без параметров
	конс_ПодключаемаяКонсольСервер.ДобавитьФункциюВКонтекст(ЭтотОбъект,
		"ПолучитьТекущегоПользователя",
		"Возвращает текущего пользователя системы");
	
КонецПроцедуры

// Пример: Добавление сниппетов (шаблонов кода)
// 
// Сниппеты - быстрые шаблоны, разворачиваются по Tab.
// ${1}, ${2} - точки табуляции, ${0} - финальная позиция курсора.
//
&НаСервере
Процедура Пример_ДобавитьСниппеты()
	
	// Сниппет для цикла
	конс_ПодключаемаяКонсольСервер.ДобавитьСниппет(ЭтотОбъект,
		"Для",
		"Для ${1:Индекс} = ${2:0} По ${3:Количество} - 1 Цикл
		|	${0}
		|КонецЦикла;",
		"Цикл Для по числовому счётчику");
	
	// Сниппет для запроса
	конс_ПодключаемаяКонсольСервер.ДобавитьСниппет(ЭтотОбъект,
		"Запрос",
		"Запрос = Новый Запрос;
		|Запрос.Текст =
		|	""ВЫБРАТЬ
		|	|	${1:*}
		|	|ИЗ
		|	|	${2:Справочник.Номенклатура}"";
		|
		|Результат = Запрос.Выполнить();
		|Выборка = Результат.Выбрать();
		|
		|Пока Выборка.Следующий() Цикл
		|	${0}
		|КонецЦикла;",
		"Создание и выполнение запроса");
	
КонецПроцедуры

// Пример: Переопределение настроек редактора
// 
// Позволяет изменить настройки по умолчанию при инициализации.
// Раскомментируйте и используйте вместо стандартной инициализации.
//
// &НаСервере
// Процедура Пример_ИнициализацияСНастройками()
// 	
// 	Параметры = Новый Структура;
// 	Параметры.Вставить("ПереопределитьНастройки", Новый Структура);
// 	Параметры.ПереопределитьНастройки.Вставить("КартаКода", Ложь);
// 	Параметры.ПереопределитьНастройки.Вставить("Тема", "ТемнаяТема");
// 	
// 	конс_ПодключаемаяКонсольСервер.ИнициализироватьРедактор(
// 		ЭтотОбъект, УникальныйИдентификатор, Параметры);
// 	
// КонецПроцедуры

#КонецОбласти
