# Добавление пользовательских функций

Пользовательские функции отображаются в автодополнении с описанием, сигнатурой и подсказками по параметрам.

## Быстрый пример

```bsl
// В ПриСозданииНаСервере
Параметры = Новый Массив;
Параметры.Добавить(конс_ПодключаемаяКонсольСервер.НовыйПараметрФункции("Сумма", "Число", "Сумма заказа"));
Параметры.Добавить(конс_ПодключаемаяКонсольСервер.НовыйПараметрФункции("Скидка", "Число", "Процент скидки"));

конс_ПодключаемаяКонсольСервер.ДобавитьФункциюВКонтекст(ЭтотОбъект,
    "ВычислитьСкидку",
    "Вычисляет итоговую сумму с учётом скидки",
    Параметры,
    "Число");

// В HTMLДокументСформирован (на клиенте)
конс_ПодключаемаяКонсольКлиент.ЗагрузитьПользовательскийКонтекст(ЭтаФорма);
```

После этого при вводе `ВычислитьСкидку(` появится подсказка с параметрами.

## Добавление функций

### Функция без параметров

```bsl
конс_ПодключаемаяКонсольСервер.ДобавитьФункциюВКонтекст(ЭтотОбъект,
    "ПолучитьТекущегоПользователя",
    "Возвращает текущего пользователя системы");
```

В автодополнении появится:
```
ПолучитьТекущегоПользователя() - Возвращает текущего пользователя системы
```

### Функция с параметрами

```bsl
// Создаём массив параметров
Параметры = Новый Массив;

// Обязательный параметр
Параметры.Добавить(конс_ПодключаемаяКонсольСервер.НовыйПараметрФункции(
    "Сумма",           // Имя параметра
    "Число",           // Тип параметра
    "Сумма заказа"));  // Описание

// Необязательный параметр (4-й аргумент = Ложь)
Параметры.Добавить(конс_ПодключаемаяКонсольСервер.НовыйПараметрФункции(
    "ПроцентСкидки",
    "Число",
    "Процент скидки от 0 до 100",
    Ложь));  // Необязательный

// Добавляем функцию
конс_ПодключаемаяКонсольСервер.ДобавитьФункциюВКонтекст(ЭтотОбъект,
    "ВычислитьСкидку",              // Имя функции
    "Вычисляет итоговую сумму",     // Описание функции
    Параметры,                       // Массив параметров
    "Число");                        // Тип возвращаемого значения
```

В автодополнении появится:
```
ВычислитьСкидку(Сумма: Число, ПроцентСкидки?: Число): Число
```

### Процедура (без возвращаемого значения)

```bsl
Параметры = Новый Массив;
Параметры.Добавить(конс_ПодключаемаяКонсольСервер.НовыйПараметрФункции(
    "Сообщение", "Строка", "Текст сообщения"));

// Не указываем тип возврата
конс_ПодключаемаяКонсольСервер.ДобавитьФункциюВКонтекст(ЭтотОбъект,
    "ЗаписатьВЛог",
    "Записывает сообщение в лог системы",
    Параметры);  // Без 5-го параметра - это процедура
```

## Описание параметра функции

Метод `НовыйПараметрФункции` создаёт описание параметра:

```bsl
Функция НовыйПараметрФункции(Имя, Тип, Описание = "", Обязательный = Истина)
```

| Параметр | Тип | Описание |
|----------|-----|----------|
| `Имя` | Строка | Имя параметра |
| `Тип` | Строка | Тип параметра (Число, Строка, Булево, СправочникСсылка и т.д.) |
| `Описание` | Строка | Описание параметра (отображается в подсказке) |
| `Обязательный` | Булево | Является ли параметр обязательным (по умолчанию Истина) |

### Примеры параметров

```bsl
// Обязательный числовой параметр
конс_ПодключаемаяКонсольСервер.НовыйПараметрФункции("Количество", "Число", "Количество товара")

// Необязательный строковый параметр
конс_ПодключаемаяКонсольСервер.НовыйПараметрФункции("Комментарий", "Строка", "Комментарий к заказу", Ложь)

// Ссылочный тип
конс_ПодключаемаяКонсольСервер.НовыйПараметрФункции("Товар", "СправочникСсылка.Номенклатура", "Ссылка на товар")

// Структура
конс_ПодключаемаяКонсольСервер.НовыйПараметрФункции("Параметры", "Структура", "Дополнительные параметры", Ложь)
```

## Полный пример

```bsl
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
    
    конс_ПодключаемаяКонсольСервер.ИнициализироватьРедактор(ЭтотОбъект, УникальныйИдентификатор);
    
    // Добавление функций
    ДобавитьПользовательскиеФункции();
    
КонецПроцедуры

&НаСервере
Процедура ДобавитьПользовательскиеФункции()
    
    // === Функция без параметров ===
    конс_ПодключаемаяКонсольСервер.ДобавитьФункциюВКонтекст(ЭтотОбъект,
        "ПолучитьТекущегоПользователя",
        "Возвращает текущего пользователя системы",
        ,  // Без параметров
        "СправочникСсылка.Пользователи");
    
    // === Функция с одним параметром ===
    Параметры1 = Новый Массив;
    Параметры1.Добавить(конс_ПодключаемаяКонсольСервер.НовыйПараметрФункции(
        "Код", "Строка", "Код товара для поиска"));
    
    конс_ПодключаемаяКонсольСервер.ДобавитьФункциюВКонтекст(ЭтотОбъект,
        "НайтиТоварПоКоду",
        "Находит товар по коду",
        Параметры1,
        "СправочникСсылка.Номенклатура");
    
    // === Функция с несколькими параметрами ===
    Параметры2 = Новый Массив;
    Параметры2.Добавить(конс_ПодключаемаяКонсольСервер.НовыйПараметрФункции(
        "Товар", "СправочникСсылка.Номенклатура", "Ссылка на товар"));
    Параметры2.Добавить(конс_ПодключаемаяКонсольСервер.НовыйПараметрФункции(
        "Дата", "Дата", "Дата актуальности цены"));
    Параметры2.Добавить(конс_ПодключаемаяКонсольСервер.НовыйПараметрФункции(
        "ТипЦены", "Строка", "Тип цены (Розничная, Оптовая)", Ложь));
    
    конс_ПодключаемаяКонсольСервер.ДобавитьФункциюВКонтекст(ЭтотОбъект,
        "ПолучитьЦену",
        "Возвращает цену товара на указанную дату",
        Параметры2,
        "Число");
    
    // === Процедура (без возвращаемого значения) ===
    Параметры3 = Новый Массив;
    Параметры3.Добавить(конс_ПодключаемаяКонсольСервер.НовыйПараметрФункции(
        "Заказ", "ДокументСсылка.ЗаказКлиента", "Заказ для отправки"));
    Параметры3.Добавить(конс_ПодключаемаяКонсольСервер.НовыйПараметрФункции(
        "Email", "Строка", "Email получателя"));
    
    конс_ПодключаемаяКонсольСервер.ДобавитьФункциюВКонтекст(ЭтотОбъект,
        "ОтправитьЗаказПоEmail",
        "Отправляет заказ на указанный email",
        Параметры3);  // Без типа возврата - это процедура
    
КонецПроцедуры

&НаКлиенте
Процедура HTMLДокументСформирован(Элемент)
    
    конс_ПодключаемаяКонсольКлиент.ОбработчикДокументСформирован(ЭтаФорма);
    конс_ПодключаемаяКонсольКлиент.ЗагрузитьПользовательскийКонтекст(ЭтаФорма);
    
КонецПроцедуры
```

## Как это работает

### В автодополнении

При вводе имени функции появляется подсказка:

```
ПолучитьЦену(Товар: СправочникСсылка.Номенклатура, Дата: Дата, ТипЦены?: Строка): Число
    Возвращает цену товара на указанную дату
```

### При вводе параметров

После открытия скобки `(` показывается подсказка с описанием текущего параметра:

```
ПолучитьЦену(
    ║ Товар: СправочникСсылка.Номенклатура - Ссылка на товар
```

При переходе к следующему параметру (после запятой):

```
ПолучитьЦену(ТоварСсылка,
    ║ Дата: Дата - Дата актуальности цены
```

## Типы параметров

Рекомендуемые названия типов для параметров:

| Тип | Описание |
|-----|----------|
| `Число` | Числовой тип |
| `Строка` | Строковый тип |
| `Дата` | Тип дата/время |
| `Булево` | Логический тип |
| `Структура` | Структура данных |
| `Массив` | Массив |
| `ТаблицаЗначений` | Таблица значений |
| `СправочникСсылка.XXX` | Ссылка на справочник |
| `ДокументСсылка.XXX` | Ссылка на документ |
| `Произвольный` | Любой тип |

## Реализация функций

Функции, добавленные через `ДобавитьФункциюВКонтекст`, **только отображаются в автодополнении**. Их реализация должна быть в доступном контексте выполнения.

### Вариант 1: Глобальный модуль

Создайте глобальный общий модуль и разместите там функции:

```bsl
// В глобальном общем модуле
Функция ВычислитьСкидку(Сумма, ПроцентСкидки = 0) Экспорт
    Возврат Сумма * (100 - ПроцентСкидки) / 100;
КонецФункции
```

### Вариант 2: Модуль менеджера

Для функций, связанных с объектами метаданных:

```bsl
// В модуле менеджера Справочники.Номенклатура
Функция НайтиТоварПоКоду(Код) Экспорт
    Возврат Справочники.Номенклатура.НайтиПоКоду(Код);
КонецФункции
```

### Вариант 3: Серверный модуль

```bsl
// В серверном общем модуле
Функция ПолучитьЦену(Товар, Дата, ТипЦены = "Розничная") Экспорт
    // Логика получения цены
    Возврат Цена;
КонецФункции
```

## Динамическое добавление

```bsl
&НаКлиенте
Процедура ДобавитьНовуюФункцию(Команда)
    
    JSONФункций = ДобавитьФункциюНаСервере();
    конс_ПодключаемаяКонсольКлиент.ЗагрузитьПользовательскиеФункции(ЭтаФорма, JSONФункций);
    
КонецПроцедуры

&НаСервере
Функция ДобавитьФункциюНаСервере()
    
    конс_ПодключаемаяКонсольСервер.ДобавитьФункциюВКонтекст(ЭтотОбъект,
        "НоваяФункция",
        "Добавлена динамически");
    
    Возврат конс_ПодключаемаяКонсольСервер.ПолучитьJSONФункций(ЭтотОбъект);
    
КонецФункции
```

## См. также

- [Добавление переменных](variables.md)
- [Сниппеты](snippets.md)
- [API Reference](api-reference.md)
