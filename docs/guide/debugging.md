# Отладка

Редактор кода содержит встроенный отладчик BSL-кода. Отладка выполняется прямо внутри Monaco-редактора — без конфигуратора и внешних инструментов. Код компилируется в байткод и интерпретируется виртуальной машиной (ВМ) на сервере 1С.

## Архитектура отладчика

```
┌─────────────────────────────────────────────────────┐
│  Monaco Editor (JavaScript)                         │
│  ┌───────────────────────────────────────────────┐  │
│  │  Панель инструментов отладки                  │  │
│  │  Glyph Margin (точки останова)                │  │
│  │  Подсветка текущей строки                     │  │
│  │  Панель отладки (переменные, сообщения,       │  │
│  │    ошибки, стек вызовов)                      │  │
│  │  JS-диалоги просмотра значений                │  │
│  └────────────┬──────────────────────────────────┘  │
│               │ события (sendEvent)                 │
│  ┌────────────▼──────────────────────────────────┐  │
│  │  конс_ПодключаемаяКонсольКлиент              │  │
│  │  (оркестрация: запуск, шаги, остановка)       │  │
│  └────────────┬──────────────────────────────────┘  │
│               │ ВызовСервера                        │
│  ┌────────────▼──────────────────────────────────┐  │
│  │  Сервер                                       │  │
│  │  ┌─────────────────────────────────────────┐  │  │
│  │  │ конс_КомпиляцияКлиентСервер             │  │  │
│  │  │ (лексер → парсер → генератор байткода)  │  │  │
│  │  └─────────────┬───────────────────────────┘  │  │
│  │                │ байткод                      │  │
│  │  ┌─────────────▼───────────────────────────┐  │  │
│  │  │ конс_ВМ_КлиентСервер                    │  │  │
│  │  │ (стековая виртуальная машина,            │  │  │
│  │  │  точки останова, пошаговое выполнение)  │  │  │
│  │  └─────────────────────────────────────────┘  │  │
│  │  конс_ПросмотрЗначенийКлиентСервер            │  │
│  │  (инспекция переменных, коллекций)            │  │
│  └───────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────┘
```

### Модули

| Модуль | Назначение |
|--------|------------|
| `конс_КомпиляцияКлиентСервер` | Компилятор: лексер + парсер + генератор байткода ВМ |
| `конс_КомпиляцияСемантикаКлиентСервер` | Семантический анализ AST-дерева |
| `конс_ВМ_КлиентСервер` | Стековая виртуальная машина: диспетчер опкодов, стек вызовов, пошаговое выполнение |
| `конс_ВМ_ОпКодыКлиентСервер` | Реализация отдельных операций (OpCode) ВМ |
| `конс_ВМ_ВызовСервера` | Проверка транзакций при отладке |
| `конс_АСТ_ЛексерКлиентСервер` | Лексический анализ BSL-кода |
| `конс_АСТ_ПарсерКлиентСервер` | Парсинг BSL-кода в AST-дерево |
| `конс_АСТ_ПостроительКлиентСервер` | Построение AST из токенов |
| `конс_АСТ_ПрепроцессорКлиентСервер` | Директивы `#Если` / `#Иначе` / `#КонецЕсли` |
| `конс_ПросмотрЗначенийКлиентСервер` | Инспекция и сериализация переменных |
| `конс_СистемаТиповКлиентСервер` | Описания системных типов платформы |
| `конс_ТаблицыПереходовКлиентСервер` | Таблицы переходов лексера/парсера |

## Быстрый старт

### Включение отладчика

Отладчик активируется через JavaScript API. После включения у редактора появляется glyph margin (поле для точек останова) и плавающая панель инструментов:

```bsl
// Включить отладчик
конс_ПодключаемаяКонсольКлиент.View(ЭтаФорма).setUsingDebugger(Истина);
```

Либо при инициализации через параметры:

```bsl
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)

    Параметры = Новый Структура;
    Параметры.Вставить("ИспользоватьОтладчик", Истина);

    конс_ПодключаемаяКонсольСервер.ИнициализироватьРедактор(
        ЭтотОбъект, УникальныйИдентификатор, Параметры);

КонецПроцедуры
```

### Жизненный цикл отладки

1. Пользователь ставит точки останова (клик по glyph margin)
2. Нажимает **F5** (Начать отладку)
3. Код компилируется на сервере (лексер → парсер → байткод)
4. ВМ запускается и выполняет байткод до первой точки останова
5. Редактор подсвечивает текущую строку, показывает панель отладки
6. Пользователь выполняет шаги, просматривает переменные
7. Нажимает **Shift+F5** для остановки или код завершается

## Точки останова

Точки останова устанавливаются **кликом** по левому полю редактора (glyph margin). Красная точка появляется рядом с номером строки.

### Программное управление

```bsl
// Получить массив номеров строк с точками останова (JSON)
JSONСтрока = конс_ПодключаемаяКонсольКлиент.View(ЭтаФорма).getBreakpoints();
// Результат: "[1,5,12]"

// Переключить точку останова на строке
конс_ПодключаемаяКонсольКлиент.View(ЭтаФорма).updateBreakpoints(5);

// Удалить все точки останова
конс_ПодключаемаяКонсольКлиент.View(ЭтаФорма).removeAllBreakpoints();
```

## Панель инструментов отладки

Плавающая панель появляется при включении отладчика. Можно перетаскивать к любой стороне окна редактора.

| Кнопка | Клавиша | Описание |
|--------|---------|----------|
| ▶ Начать отладку | **F5** | Компилирует код и запускает ВМ |
| ▶▮ Продолжить | **F5** | Выполняет до следующей точки останова |
| ⤵ Шагнуть через | **F10** | Следующая строка (не заходит в процедуры) |
| ↓ Шагнуть в | **F11** | Переход внутрь вызываемой процедуры/функции |
| ■ Остановить | **Shift+F5** | Завершает сеанс отладки |
| =? Вычислить | **Shift+F9** | Открывает диалог вычисления выражения |
| ⚠ Остановка по ошибке | — | Вкл./выкл.: остановка ВМ при возникновении ошибки |

## Панель отладки

При остановке на точке останова внизу редактора появляется панель с четырьмя вкладками:

### Переменные

Дерево всех переменных текущей области видимости. Для каждой переменной показано:
- Имя
- Значение (строковое представление)
- Тип

Сложные переменные (структуры, таблицы значений, массивы) раскрываются по клику.

**Контекстное меню** переменной:
- *Вычислить выражение* — открывает диалог вычисления
- *Удалить* — удаляет пользовательское наблюдаемое выражение

### Сообщения

Список вызовов `Сообщить()` из выполняемого кода.

### Ошибки

Список ошибок, возникших при выполнении. Клик по ошибке переходит на соответствующую строку в редакторе (с подсветкой).

### Стек вызовов

Иерархия вызовов процедур/функций. Клик по фрейму переходит на строку вызова в редакторе.

## Вычисление выражений

Во время остановки на точке останова доступен диалог вычисления выражений (**Shift+F9**):

1. Введите BSL-выражение в поле ввода
2. Нажмите «Вычислить»
3. Результат отображается в виде дерева с типом и значением

Выражение компилируется и вычисляется на сервере в контексте текущей ВМ — доступны все переменные текущей области видимости.

```bsl
// Программный вызов
конс_ПодключаемаяКонсольКлиент.ВычислитьВыражение(ЭтаФорма, "МояПеременная.Количество()");
```

### Просмотр строковых значений

Для длинных строковых значений открывается отдельный диалог с полным текстом (режим только чтение).

### Просмотр коллекций

Для массивов, таблиц значений и других коллекций открывается табличный диалог с постраничной навигацией.

## Остановка по ошибке

Режим «Остановка по ошибке» (кнопка ⚠ в панели) позволяет остановить ВМ при возникновении исключения — даже если ошибка перехватывается блоком `Попытка-Исключение`. Это полезно для отладки перехваченных ошибок.

```bsl
// Программное переключение
Параметры = Форма.конс_СтруктураПараметровРедактораКода;
Параметры.ОстановкаПоОшибке = Истина;
```

## Программный API (BSL)

### Запуск и управление

```bsl
// Начать отладку
конс_ПодключаемаяКонсольКлиент.НачатьОтладку(ЭтаФорма);

// Продолжить до следующей точки останова
конс_ПодключаемаяКонсольКлиент.ПродолжитьОтладку(ЭтаФорма);

// Шагнуть в (F11) — заходит в процедуры/функции
конс_ПодключаемаяКонсольКлиент.ШагнутьВ(ЭтаФорма);

// Шагнуть через (F10) — не заходит в процедуры
конс_ПодключаемаяКонсольКлиент.ШагнутьЧерез(ЭтаФорма);

// Завершить отладку
конс_ПодключаемаяКонсольКлиент.ЗавершитьОтладку(ЭтаФорма);
```

### Вычисление выражения

```bsl
// Открыть диалог вычисления (берёт выделенный текст, если выражение не указано)
конс_ПодключаемаяКонсольКлиент.ВычислитьВыражение(ЭтаФорма, "МояПеременная");

// Вычислить на сервере и получить JSON
РезультатJSON = конс_ПодключаемаяКонсольВызовСервера.ВычислитьВыражениеВJSON(
    АдресВМ, "СтрДлина(МояСтрока)");
```

## JavaScript API

### Включение/отключение

| Функция | Описание |
|---------|----------|
| `setUsingDebugger(enabled)` | Включить/отключить режим отладки. Показывает glyph margin и панель инструментов |

### Точки останова

| Функция | Описание |
|---------|----------|
| `updateBreakpoints(line)` | Переключить точку останова на строке |
| `getBreakpoints()` | Получить JSON-массив номеров строк с точками останова |
| `removeAllBreakpoints()` | Удалить все точки останова |

### Управление выполнением

| Функция | Описание |
|---------|----------|
| `startDebugging()` | Начать отладку (компиляция + запуск ВМ) |
| `continueDebugging()` | Продолжить до следующей точки останова |
| `stepOver()` | Шагнуть через (F10) |
| `stepInto()` | Шагнуть в (F11) |
| `stopDebugging()` | Завершить отладку |

### Режим отладки

| Функция | Описание |
|---------|----------|
| `setDebugMode(mode)` | Установить режим: `1` — отладка активна, `0` — нет |
| `isDebugMode()` | Проверить, активен ли режим отладки |
| `setCurrentDebugLine(line)` | Подсветить текущую строку выполнения |
| `deleteCurrentDebugLine()` | Убрать подсветку текущей строки |

### Инспекция значений

| Функция | Описание |
|---------|----------|
| `evaluateExpression()` | Открыть диалог вычисления (берёт выделенный текст) |
| `showExpressionDialog(expression)` | Открыть диалог просмотра выражения |
| `updateExpressionResult(json, errorText)` | Обновить результат в диалоге |
| `showStringDialog(value, title)` | Открыть диалог просмотра строки |
| `showCollectionDialog(json)` | Открыть диалог просмотра коллекции |
| `updateCollectionPage(json)` | Обновить страницу коллекции |

### Панель отладки

| Функция | Описание |
|---------|----------|
| `showDebugPanel(dataJSON)` | Показать панель с переменными, сообщениями, ошибками и стеком |
| `hideDebugPanel()` | Скрыть панель отладки |
| `showVariablesDescription(json)` | Показать дерево переменных |
| `updateVariableDescription(id, json)` | Обновить поддерево переменной (lazy-load) |

### Остановка по ошибке

| Функция | Описание |
|---------|----------|
| `toggleStopOnError()` | Переключить режим остановки по ошибке |
| `getStopOnError()` | Текущее состояние флага |

## События отладки (JS → 1C)

| Событие | Когда | Параметры |
|---------|-------|-----------|
| `EVENT_START_DEBUGGING` | Нажата кнопка «Начать отладку» | Токены lezer (JSON) |
| `EVENT_CONTINUE_DEBUGGING` | Нажата кнопка «Продолжить» | — |
| `EVENT_STEP_OVER` | Шагнуть через (F10) | — |
| `EVENT_STEP_INTO` | Шагнуть в (F11) | — |
| `EVENT_STOP_DEBUGGING` | Остановить отладку | — |
| `EVENT_UPDATE_BREAKPOINTS` | Изменены точки останова | JSON-массив номеров строк |
| `EVENT_REMOVE_ALL_BREAKPOINTS` | Удалены все точки останова | `[]` |
| `EVENT_EVALUATE_EXPRESSION` | Вычислить выражение | Текст выражения |
| `EVENT_TOGGLE_STOP_ON_ERROR` | Переключена остановка по ошибке | `"1"` / `"0"` |
| `EVENT_DIALOG_EVALUATE` | Вычисление из JS-диалога | `{ expression }` |
| `EVENT_DIALOG_GET_VARIABLE_DATA` | Раскрытие переменной в диалоге | `{ variableName, variableId, variablePath }` |
| `EVENT_DIALOG_GET_COLLECTION_PAGE` | Запрос страницы коллекции | `{ page, pageSize, address, variableName }` |

## Пример: минимальная интеграция отладчика

```bsl
// === ПриСозданииНаСервере ===
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)

    конс_ПодключаемаяКонсольСервер.ИнициализироватьРедактор(
        ЭтотОбъект, УникальныйИдентификатор);

КонецПроцедуры

// === ПриОткрытии ===
&НаКлиенте
Процедура ПриОткрытии(Отказ)

    конс_ПодключаемаяКонсольКлиент.ПодключитьРедактор(ЭтаФорма);

КонецПроцедуры

// === HTMLДокументСформирован ===
&НаКлиенте
Процедура HTMLДокументСформирован(Элемент)

    конс_ПодключаемаяКонсольКлиент.ОбработчикДокументСформирован(ЭтаФорма);

    // Включаем отладчик после инициализации
    конс_ПодключаемаяКонсольКлиент.View(ЭтаФорма).setUsingDebugger(Истина);

КонецПроцедуры

// === HTMLПриНажатии ===
&НаКлиенте
Процедура HTMLПриНажатии(Элемент, ДанныеСобытия, СтандартнаяОбработка)

    конс_ПодключаемаяКонсольКлиент.ОбработчикПриНажатии(ЭтаФорма, ДанныеСобытия);

КонецПроцедуры
```

После этого:
1. Откройте форму
2. Введите BSL-код
3. Кликните по левому полю, чтобы поставить точку останова
4. Нажмите **F5** — код скомпилируется и начнёт выполняться
5. При остановке на точке — используйте **F10** / **F11** для пошагового выполнения

## Пример: отладка с пользовательскими переменными

Если вам нужно, чтобы отлаживаемый код имел доступ к переменным с типизацией:

```bsl
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)

    конс_ПодключаемаяКонсольСервер.ИнициализироватьРедактор(
        ЭтотОбъект, УникальныйИдентификатор);

    // Переменная будет доступна в отлаживаемом коде
    конс_ПодключаемаяКонсольСервер.ДобавитьПеременную(ЭтотОбъект,
        "_Товар", Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));

КонецПроцедуры
```

При запуске отладки переменная `_Товар` будет доступна в контексте ВМ и отобразится на вкладке «Переменные» панели отладки.

## Процесс компиляции

Когда пользователь нажимает **F5**, происходит следующее:

1. **Экспорт lezer-токенов** — если доступен AST-сервис, Monaco экспортирует предварительно разобранные токены и передаёт их в событие `EVENT_START_DEBUGGING`
2. **Лексический анализ** (`конс_АСТ_ЛексерКлиентСервер`) — разбивает код на токены (если lezer-токены не предоставлены)
3. **Парсинг** (`конс_АСТ_ПарсерКлиентСервер`) — строит AST-дерево
4. **Семантический анализ** (`конс_КомпиляцияСемантикаКлиентСервер`) — проверка типов, разрешение имён
5. **Генерация байткода** (`конс_КомпиляцияКлиентСервер`) — обход AST, генерация команд ВМ
6. **Инициализация ВМ** (`конс_ВМ_КлиентСервер`) — создание стека, загрузка байткода
7. **Запуск** — ВМ выполняет байткод до первой точки останова или конца программы

При ошибке компиляции строка с ошибкой подсвечивается в редакторе, выполнение не начинается.

## Ограничения

- Отладка выполняется **на сервере** — точки останова работают только для серверного кода
- Код выполняется в интерпретаторе ВМ, а не в движке `Выполнить()` платформы — возможны отличия в поведении
- Пошаговое выполнение поддерживает основные конструкции BSL: переменные, ветвления, циклы, процедуры/функции, `Попытка-Исключение`, рекурсию
- Встроенные функции платформы (строковые, числовые, работа с датой) эмулируются через вызов `Выполнить()` на сервере
